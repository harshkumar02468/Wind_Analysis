{% extends "base.html" %}
{% block title %}Wind Data Analysis Dashboard{% endblock %}
{% block content %}
    <style>
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #495057;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --border-radius: 6px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            line-height: 1.6;
            color: #333;
            background-color: transparent;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .dashboard-card {
            background-color: transparent;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-bottom: 30px;
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        .dashboard-card:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }
        h2 {
            color: var(--secondary-color);
            font-weight: 500;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }
        h3 {
            color: var(--secondary-color);
            font-weight: 500;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        .state-selection {
            margin-bottom: 25px;
        }
        .checkbox-group {
            background-color: transparent;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 12px;
            background-color: transparent;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }
        .checkbox-label:hover {
            background-color: var(--medium-gray);
        }
        .checkbox-label input {
            margin-right: 8px;
        }
        .mast-container {
    margin-top: 20px;
    display: none;
    background-color: transparent;
    border-radius: var(--border-radius);
    padding: 15px;
}
.mast-box {
    margin-bottom: 20px;
    padding: 15px;
    background-color: transparent;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    position: relative;
}
        .dropdown-group {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .select-wrapper {
            flex: 1;
            min-width: 200px;
        }
        .select-wrapper label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.85rem;
            color: var(--dark-gray);
            font-weight: 500;
        }
        select {
            width: 100%;
            padding: 10px 12px;
            border-radius: var(--border-radius);
            border: 1px solid #ced4da;
            background-color: transparent;
            font-size: 0.9rem;
            transition: var(--transition);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23333' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
        }
        select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        .sector-select {
            min-width: 180px;
        }
        .add-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 40px;
            justify-content: center;
        }
        .add-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }
        .remove-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 40px;
            justify-content: center;
        }
        .remove-btn:hover {
            background-color: #c82333;
            transform: translateY(-1px);
        }
        .add-btn i, .remove-btn i {
            font-size: 1rem;
        }
        .date-inputs {
            background-color: transparent;
            display: flex;
            gap: 30px;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        .date-input {
            flex: 1;
            min-width: 200px;
        }
        .date-input label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.85rem;
            color: var(--dark-gray);
            font-weight: 500;
        }
        input[type="date"] {
            width: 100%;
            padding: 10px 12px;
            border-radius: var(--border-radius);
            border: 1px solid #ced4da;
            font-size: 0.9rem;
            transition: var(--transition);
        }
        input[type="date"]:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.95rem;
            transition: var(--transition);
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .btn:disabled {
            background-color: transparent;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        .status-message {
            text-align: center;
            margin: 15px 0;
            padding: 12px;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            display: none;
        }
        .status-message.info {
            background-color: transparent;
            color: #1864ab;
            border-left: 4px solid #1864ab;
        }
        .status-message.success {
            background-color: #ebfbee;
            color: #2b8a3e;
            border-left: 4px solid #2b8a3e;
        }
        .status-message.error {
            background-color: #fff3bf;
            color: #e67700;
            border-left: 4px solid #e67700;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: transparent;
            overflow: auto;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal.show {
            opacity: 1;
        }
        .modal-content {
            background-color:  #cedeee;
            margin: 5% auto;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            width: 85%;
            max-width: 1000px;
            max-height: 85vh;
            overflow: auto;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }
        .close {
            color: #adb5bd;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 15px;
            transition: var(--transition);
        }
        .close:hover {
            color: var(--accent-color);
        }
        .modal-title {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--medium-gray);
            color: var(--secondary-color);
            font-weight: 500;
        }
        .chart-container {
            width: 100%;
            height: 500px;
            margin-bottom: 20px;
        }
        .analysis-options {
            background-color: transparent;
            margin: 20px 0;
            padding: 20px;
            border-radius: var(--border-radius);
        }
        .checkbox-container {
            background-color: transparent;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
        }
        .checkbox-item input {
            background-color: transparent;
            margin-right: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
            box-shadow: 0 0 0 1px var(--medium-gray);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid var(--medium-gray);
        }
        th {
            background-color: var(--light-gray);
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        tr:nth-child(even) {
            background-color: transparent;
        }
        tr:hover {
            background-color: transparent;
        }
        .resize-handle {
            position: absolute;
            right: 0;
            bottom: 0;
            width: 20px;
            height: 20px;
            cursor: se-resize;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20' fill='%23999'%3E%3Cpath d='M13 10l-3-3v2H8v2h2v2l3-3zM7 10l3 3v-2h2v-2h-2V7L7 10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: bottom right;
        }
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }
            .dropdown-group {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            .select-wrapper {
                min-width: 100%;
            }
            .modal-content {
                width: 95%;
                padding: 20px 15px;
            }
            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            .btn {
                width: 100%;
            }
        }
        /* Utility classes */
        .text-center {
            text-align: center;
        }
        .mb-3 {
            margin-bottom: 1rem;
        }
        .mt-3 {
            margin-top: 1rem;
        }
        .d-flex {
            display: flex;
        }
        .align-items-center {
            align-items: center;
        }
        .justify-content-between {
            justify-content: space-between;
        }
    </style>
    <div class="container">
        <div id="status-message" class="status-message"></div>
        <div class="dashboard-card">
            <div class="state-selection">
                <h3>Select States:</h3>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="state" value="Andhra Pradesh"> Andhra Pradesh
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="state" value="Madhya Pradesh"> Madhya Pradesh
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="state" value="Rajasthan"> Rajasthan
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="state" value="Telangana"> Telangana
                    </label>
                </div>
            </div>
            <div id="state-containers"></div>
            <div class="date-inputs">
                <div class="date-input">
                    <label for="start-date">Start Date:</label>
                    <input type="date" id="start-date" name="start-date">
                </div>
                <div class="date-input">
                    <label for="end-date">End Date:</label>
                    <input type="date" id="end-date" name="end-date">
                </div>
            </div>
        </div>
        <div class="dashboard-card analysis-options">
            <h3>Analysis Options:</h3>
            <div class="checkbox-container">
                <label class="checkbox-item">
                    <input type="checkbox" name="analysis-type" value="speed" checked> Include Wind Speed Analysis
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" name="analysis-type" value="direction"> Include Wind Direction Analysis
                </label>
            </div>
            <div id="direction-options" style="display: none; margin-top: 15px;">
                <div class="select-wrapper">
                    <label for="sector-count">Number of Sectors:</label>
                    <select id="sector-count" class="sector-select">
                        <option value="4">4 Sectors (90° each)</option>
                        <option value="8">8 Sectors (45° each)</option>
                        <option value="12" selected>12 Sectors (30° each)</option>
                        <option value="16">16 Sectors (22.5° each)</option>
                        <option value="24">24 Sectors (15° each)</option>
                        <option value="36">36 Sectors (10° each)</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="text-center">
            <button id="submit-btn" class="btn">
                <span id="submit-spinner" class="loading" style="display: none;"></span>
                <span id="submit-text">Process Data</span>
            </button>
        </div>
        <div class="action-buttons">
            <button id="speed-graph-btn" class="btn btn-secondary" disabled>
                <i class="fas fa-chart-line"></i> Wind Speed Graph
            </button>
            <button id="speed-table-btn" class="btn btn-secondary" disabled>
                <i class="fas fa-table"></i> Wind Speed Table
            </button>
            <button id="direction-diagram-btn" class="btn btn-secondary" disabled>
                <i class="fas fa-wind"></i> Wind Direction Diagram
            </button>
            <button id="direction-table-btn" class="btn btn-secondary" disabled>
                <i class="fas fa-list"></i> Wind Direction Table
            </button>
        </div>
    </div>
    <div id="speed-graph-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="modal-title">Wind Speed Graph</h2>
            <div id="graph-container" class="chart-container"></div>
            <div class="resize-handle"></div>
        </div>
    </div>
    <div id="speed-table-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="modal-title">Wind Speed Table</h2>
            <div id="table-container"></div>
            <div class="resize-handle"></div>
        </div>
    </div>
    <div id="direction-diagram-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="modal-title">Wind Direction Diagram</h2>
            <div id="wind-rose-container" class="chart-container"></div>
            <div class="resize-handle"></div>
        </div>
    </div>
    <div id="direction-table-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="modal-title">Wind Direction Table</h2>
            <div id="wind-rose-table-container"></div>
            <div class="resize-handle"></div>
        </div>
    </div>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.plot.ly/plotly-2.14.0.min.js"></script>
    <script>
        // State data structure to track selections
        const stateData = {
            "Andhra Pradesh": { selected: false, masts: [] },
            "Madhya Pradesh": { selected: false, masts: [] },
            "Rajasthan": { selected: false, masts: [] },
            "Telangana": { selected: false, masts: [] }
        };
        // Store analysis results
        let analysisResults = {
            speed: null,
            direction: null
        };
        // Initialize modal functionality
        function initModals() {
            // Get all modal elements
            const modals = [
                { id: 'speed-graph-modal', btnId: 'speed-graph-btn' },
                { id: 'speed-table-modal', btnId: 'speed-table-btn' },
                { id: 'direction-diagram-modal', btnId: 'direction-diagram-btn' },
                { id: 'direction-table-modal', btnId: 'direction-table-btn' }
            ];
            modals.forEach(modal => {
                const modalElement = document.getElementById(modal.id);
                const btn = document.getElementById(modal.btnId);
                const span = modalElement.querySelector('.close');
                // When the user clicks the button, open the modal
                btn.onclick = function() {
                    modalElement.style.display = "block";
                    setTimeout(() => {
                        modalElement.classList.add('show');
                    }, 10);
                }
                // When the user clicks on <span> (x), close the modal
                span.onclick = function() {
                    modalElement.classList.remove('show');
                    setTimeout(() => {
                        modalElement.style.display = "none";
                    }, 300);
                }
                // When the user clicks anywhere outside of the modal, close it
                window.onclick = function(event) {
                    if (event.target == modalElement) {
                        modalElement.classList.remove('show');
                        setTimeout(() => {
                            modalElement.style.display = "none";
                        }, 300);
                    }
                }
            });
            // Make all modals draggable and resizable
            makeDraggableAndResizable(document.getElementById('direction-table-modal'));
            makeDraggableAndResizable(document.getElementById('direction-diagram-modal'));
            makeDraggableAndResizable(document.getElementById('speed-table-modal'));
            makeDraggableAndResizable(document.getElementById('speed-graph-modal'));
        }
        // Make modal content draggable and resizable
        function makeDraggableAndResizable(element) {
            const header = element.querySelector('.modal-title') || element.querySelector('.modal-content');
            const content = element.querySelector('.modal-content');
            const resizeHandle = element.querySelector('.resize-handle');
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            let isResizing = false;
            // Dragging functionality
            header.onmousedown = dragMouseDown;
            function dragMouseDown(e) {
                if (isResizing) return;
                e = e || window.event;
                e.preventDefault();
                // Get the mouse cursor position at startup
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                // Call a function whenever the cursor moves
                document.onmousemove = elementDrag;
            }
            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                if (isResizing) {
                    // Calculate the new width and height
                    const newWidth = e.clientX - content.offsetLeft;
                    const newHeight = e.clientY - content.offsetTop;
                    // Apply minimum dimensions
                    if (newWidth > 400) {
                        content.style.width = newWidth + 'px';
                    }
                    if (newHeight > 300) {
                        content.style.height = newHeight + 'px';
                    }
                } else {
                    // Calculate the new cursor position
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    // Set the element's new position
                    content.style.top = (content.offsetTop - pos2) + "px";
                    content.style.left = (content.offsetLeft - pos1) + "px";
                }
            }
            function closeDragElement() {
                // Stop moving when mouse button is released
                document.onmouseup = null;
                document.onmousemove = null;
                isResizing = false;
            }
            // Resizing functionality
            resizeHandle.onmousedown = function(e) {
                isResizing = true;
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                e.preventDefault();
            };
        }
        // Event listeners for analysis type checkboxes
        document.querySelectorAll('input[name="analysis-type"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const directionOptions = document.getElementById('direction-options');
                if (this.value === 'direction') {
                    directionOptions.style.display = this.checked ? 'block' : 'none';
                }
            });
        });
        // Event listeners for state checkboxes
        document.querySelectorAll('input[name="state"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const state = this.value;
                stateData[state].selected = this.checked;
                if (this.checked) {
                    createStateContainer(state);
                } else {
                    removeStateContainer(state);
                }
            });
        });
        // Create container for a selected state
        function createStateContainer(state) {
            const container = document.createElement('div');
            container.id = `${state.replace(/\s+/g, '-')}-container`;
            container.className = 'mast-container';
            const heading = document.createElement('h3');
            heading.textContent = `${state} Masts`;
            container.appendChild(heading);
            // Create the first mast box with add button
            const firstBox = createMastBox(state, true);
            container.appendChild(firstBox);
            document.getElementById('state-containers').appendChild(container);
            container.style.display = 'block';
            // Fetch mast list for this state
            fetchMasts(state, firstBox.querySelector('.mast-select'));
        }
        // Remove container for a deselected state
        function removeStateContainer(state) {
            const id = `${state.replace(/\s+/g, '-')}-container`;
            const container = document.getElementById(id);
            if (container) {
                container.remove();
            }
        }
        // Create a mast selection box
        function createMastBox(state, isFirst = false) {
            const box = document.createElement('div');
            box.className = 'mast-box';
            const dropdownGroup = document.createElement('div');
            dropdownGroup.className = 'dropdown-group';
            // Mast dropdown wrapper
            const mastWrapper = document.createElement('div');
            mastWrapper.className = 'select-wrapper';
            // Mast dropdown label
            const mastLabel = document.createElement('label');
            mastLabel.textContent = 'Mast';
            mastLabel.setAttribute('for', `mast-select-${state.replace(/\s+/g, '-')}`);
            // Mast dropdown
            const mastSelect = document.createElement('select');
            mastSelect.className = 'mast-select';
            mastSelect.id = `mast-select-${state.replace(/\s+/g, '-')}`;
            mastSelect.dataset.state = state;
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select Mast';
            mastSelect.appendChild(defaultOption);
            mastWrapper.appendChild(mastLabel);
            mastWrapper.appendChild(mastSelect);
            // Speed dropdown wrapper
            const speedWrapper = document.createElement('div');
            speedWrapper.className = 'select-wrapper';
            // Speed dropdown label
            const speedLabel = document.createElement('label');
            speedLabel.textContent = 'Speed Column';
            speedLabel.setAttribute('for', `speed-select-${state.replace(/\s+/g, '-')}`);
            // Speed dropdown
            const speedSelect = document.createElement('select');
            speedSelect.className = 'speed-select';
            speedSelect.id = `speed-select-${state.replace(/\s+/g, '-')}`;
            speedSelect.disabled = true;
            const speedDefaultOption = document.createElement('option');
            speedDefaultOption.value = '';
            speedDefaultOption.textContent = 'Select Speed Column';
            speedSelect.appendChild(speedDefaultOption);
            speedWrapper.appendChild(speedLabel);
            speedWrapper.appendChild(speedSelect);
            // Direction dropdown wrapper
            const directionWrapper = document.createElement('div');
            directionWrapper.className = 'select-wrapper';
            // Direction dropdown label
            const directionLabel = document.createElement('label');
            directionLabel.textContent = 'Direction Column';
            directionLabel.setAttribute('for', `direction-select-${state.replace(/\s+/g, '-')}`);
            // Direction dropdown
            const directionSelect = document.createElement('select');
            directionSelect.className = 'direction-select';
            directionSelect.id = `direction-select-${state.replace(/\s+/g, '-')}`;
            directionSelect.disabled = true;
            const directionDefaultOption = document.createElement('option');
            directionDefaultOption.value = '';
            directionDefaultOption.textContent = 'Select Direction Column';
            directionSelect.appendChild(directionDefaultOption);
            directionWrapper.appendChild(directionLabel);
            directionWrapper.appendChild(directionSelect);
            // Action button
            let actionButton;
            if (isFirst) {
                // Add button for the first mast box
                actionButton = document.createElement('button');
                actionButton.className = 'add-btn';
                actionButton.innerHTML = '<i class="fas fa-plus"></i>';
                actionButton.title = 'Add another mast for this state';
                // Add button functionality
                actionButton.onclick = function() {
                    const newBox = createMastBox(state);
                    this.closest('.mast-container').appendChild(newBox);
                    fetchMasts(state, newBox.querySelector('.mast-select'));
                };
            } else {
                // Remove button for additional mast boxes
                actionButton = document.createElement('button');
                actionButton.className = 'remove-btn';
                actionButton.innerHTML = '<i class="fas fa-times"></i>';
                actionButton.title = 'Remove this mast selection';
                // Remove button functionality
                actionButton.onclick = function() {
                    this.closest('.mast-box').remove();
                };
            }
            dropdownGroup.appendChild(mastWrapper);
            dropdownGroup.appendChild(speedWrapper);
            dropdownGroup.appendChild(directionWrapper);
            dropdownGroup.appendChild(actionButton);
            box.appendChild(dropdownGroup);
            // Add event listener for mast selection
            mastSelect.addEventListener('change', function() {
                const selectedMast = this.value;
                const speedSelect = this.parentElement.parentElement.querySelector('.speed-select');
                const directionSelect = this.parentElement.parentElement.querySelector('.direction-select');
                if (selectedMast) {
                    fetchColumns(this.dataset.state, selectedMast, speedSelect, directionSelect);
                } else {
                    speedSelect.disabled = true;
                    speedSelect.innerHTML = '';
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Select Speed Column';
                    speedSelect.appendChild(defaultOption);
                    directionSelect.disabled = true;
                    directionSelect.innerHTML = '';
                    const dirDefaultOption = document.createElement('option');
                    dirDefaultOption.value = '';
                    dirDefaultOption.textContent = 'Select Direction Column';
                    directionSelect.appendChild(dirDefaultOption);
                }
            });
            return box;
        }
function fetchMasts(state, mastSelectElement) {
    mastSelectElement.disabled = true;
    mastSelectElement.innerHTML = '';
    const loadingOption = document.createElement('option');
    loadingOption.value = '';
    loadingOption.textContent = 'Loading masts...';
    mastSelectElement.appendChild(loadingOption);
    console.log(`Fetching masts for state: ${state}`); // Debug
    fetch('/get_mast', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ state: state })
    })
    .then(response => {
        console.log('Response status:', response.status); // Debug
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data); // Debug
        mastSelectElement.innerHTML = '';
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Select Mast';
        mastSelectElement.appendChild(defaultOption);
        if (data.success && data.masts && data.masts.length > 0) {
            data.masts.forEach(mast => {
                const option = document.createElement('option');
                option.value = mast;
                option.textContent = mast;
                mastSelectElement.appendChild(option);
            });
        } else {
            const errorOption = document.createElement('option');
            errorOption.value = '';
            errorOption.textContent = data.message || 'No masts found';
            mastSelectElement.appendChild(errorOption);
        }
        mastSelectElement.disabled = false;
    })
    .catch(error => {
        console.error('Fetch error:', error); // Debug
        mastSelectElement.innerHTML = '';
        const errorOption = document.createElement('option');
        errorOption.value = '';
        errorOption.textContent = 'Error: ' + error.message;
        mastSelectElement.appendChild(errorOption);
    });
}
        // Fetch columns for a mast
        function fetchColumns(state, mast, speedSelectElement, directionSelectElement) {
            // Show loading state for both dropdowns
            speedSelectElement.disabled = true;
            directionSelectElement.disabled = true;
            const loadingOption = document.createElement('option');
            loadingOption.value = '';
            loadingOption.textContent = 'Loading columns...';
            speedSelectElement.innerHTML = '';
            speedSelectElement.appendChild(loadingOption.cloneNode(true));
            directionSelectElement.innerHTML = '';
            directionSelectElement.appendChild(loadingOption.cloneNode(true));
            fetch('/get_column', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    state: state, 
                    mast: mast 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Populate speed columns
                    speedSelectElement.innerHTML = '';
                    const speedDefaultOption = document.createElement('option');
                    speedDefaultOption.value = '';
                    speedDefaultOption.textContent = 'Select Speed Column';
                    speedSelectElement.appendChild(speedDefaultOption);
                    data.speed_columns.forEach(column => {
                        const option = document.createElement('option');
                        option.value = column;
                        option.textContent = column;
                        speedSelectElement.appendChild(option);
                    });
                    speedSelectElement.disabled = false;
                    // Populate direction columns
                    directionSelectElement.innerHTML = '';
                    const directionDefaultOption = document.createElement('option');
                    directionDefaultOption.value = '';
                    directionDefaultOption.textContent = 'Select Direction Column';
                    directionSelectElement.appendChild(directionDefaultOption);
                    data.direction_columns.forEach(column => {
                        const option = document.createElement('option');
                        option.value = column;
                        option.textContent = column;
                        directionSelectElement.appendChild(option);
                    });
                    directionSelectElement.disabled = false;
                } else {
                    speedSelectElement.innerHTML = '';
                    directionSelectElement.innerHTML = '';
                    const errorOption = document.createElement('option');
                    errorOption.value = '';
                    errorOption.textContent = 'Error loading columns';
                    speedSelectElement.appendChild(errorOption.cloneNode(true));
                    directionSelectElement.appendChild(errorOption.cloneNode(true));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                speedSelectElement.innerHTML = '';
                directionSelectElement.innerHTML = '';
                const errorOption = document.createElement('option');
                errorOption.value = '';
                errorOption.textContent = 'Error loading columns';
                speedSelectElement.appendChild(errorOption.cloneNode(true));
                directionSelectElement.appendChild(errorOption.cloneNode(true));
            });
        }
        // Submit button handler
        document.getElementById('submit-btn').addEventListener('click', function() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const speedAnalysisChecked = document.querySelector('input[name="analysis-type"][value="speed"]').checked;
            const directionAnalysisChecked = document.querySelector('input[name="analysis-type"][value="direction"]').checked;
            if (!startDate || !endDate) {
                showStatusMessage('Please select both start and end dates', 'error');
                return;
            }
            if (!speedAnalysisChecked && !directionAnalysisChecked) {
                showStatusMessage('Please select at least one analysis type', 'error');
                return;
            }
            // Collect all selections
            const selections = [];
            const stateContainers = document.querySelectorAll('.mast-container');
            stateContainers.forEach(container => {
                const state = container.id.replace('-container', '').replace(/-/g, ' ');
                const mastBoxes = container.querySelectorAll('.mast-box');
                mastBoxes.forEach(box => {
                    const mastSelect = box.querySelector('.mast-select');
                    const speedSelect = box.querySelector('.speed-select');
                    const directionSelect = box.querySelector('.direction-select');
                    if (mastSelect.value) {
                        const selection = {
                            state: state,
                            mast: mastSelect.value,
                            speed_column: speedSelect.value,
                            direction_column: directionSelect.value
                        };
                        // Only add if at least one analysis type is selected with valid columns
                        if ((speedAnalysisChecked && speedSelect.value) || 
                            (directionAnalysisChecked && directionSelect.value)) {
                            selections.push(selection);
                        }
                    }
                });
            });
            if (selections.length === 0) {
                showStatusMessage('Please select at least one mast with appropriate columns for the selected analysis types', 'error');
                return;
            }
            // Show loading state
            const submitBtn = document.getElementById('submit-btn');
            const submitText = document.getElementById('submit-text');
            const submitSpinner = document.getElementById('submit-spinner');
            submitBtn.disabled = true;
            submitText.textContent = 'Processing...';
            submitSpinner.style.display = 'inline-block';
            showStatusMessage('Processing data... Please wait', 'info');
            // Prepare request data
            const requestData = {
                start_date: startDate,
                end_date: endDate,
                selections: selections,
                speed_analysis: speedAnalysisChecked,
                direction_analysis: directionAnalysisChecked
            };
            if (directionAnalysisChecked) {
                requestData.sector_count = parseInt(document.getElementById('sector-count').value);
            }
            // Submit data to server
            fetch('/generate_analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                submitBtn.disabled = false;
                submitText.textContent = 'Process Data';
                submitSpinner.style.display = 'none';
                if (data.success) {
                    // Store the results
                    analysisResults.speed = data.speed_results || null;
                    analysisResults.direction = data.direction_results || null;
                    // Enable appropriate action buttons
                    document.getElementById('speed-graph-btn').disabled = !analysisResults.speed;
                    document.getElementById('speed-table-btn').disabled = !analysisResults.speed;
                    document.getElementById('direction-diagram-btn').disabled = !analysisResults.direction;
                    document.getElementById('direction-table-btn').disabled = !analysisResults.direction;
                    showStatusMessage('Data processing completed successfully! Click the buttons above to view results.', 'success');
                } else {
                    showStatusMessage('Error: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                submitBtn.disabled = false;
                submitText.textContent = 'Process Data';
                submitSpinner.style.display = 'none';
                showStatusMessage('An error occurred while processing your request', 'error');
            });
        });
        // Show status message
        function showStatusMessage(message, type) {
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.style.display = 'block';
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 5000);
            }
        }
        // Action button handlers
        document.getElementById('speed-graph-btn').addEventListener('click', function() {
            if (analysisResults.speed) {
                displaySpeedGraph(analysisResults.speed);
            }
        });
        document.getElementById('speed-table-btn').addEventListener('click', function() {
            if (analysisResults.speed) {
                displaySpeedTable(analysisResults.speed);
            }
        });
        document.getElementById('direction-diagram-btn').addEventListener('click', function() {
            if (analysisResults.direction) {
                displayWindRoseDiagram(analysisResults.direction);
            }
        });
        document.getElementById('direction-table-btn').addEventListener('click', function() {
            if (analysisResults.direction) {
                displayWindRoseTable(analysisResults.direction);
            }
        });
        // Display speed graph
        function displaySpeedGraph(data) {
            const graphContainer = document.getElementById('graph-container');
            graphContainer.innerHTML = '';
            // Prepare data for Plotly line graph
            const traces = [];
            const monthNames = data.monthly_data.map(month => month.month);
            // Create a trace for each selection (site)
            data.selections.forEach((selection, index) => {
                // Get the values for this selection across all months
                const values = data.monthly_data.map(month => month.values[index]);
          traces.push({
    x: monthNames,
    y: values,
    type: 'scatter',
    mode: 'lines+markers',
    name: `${selection.state} - ${selection.mast} - ${selection.speed_column}`,
    line: {
        color: getColor(index),
        width: 2
    },
    marker: {
        size: 6,
        color: getColor(index)
    },
    hovertemplate: `
        <span style='color:${getColor(index)};font-weight:bold'>${selection.state} - ${selection.mast}</span><br>
        <span style='color:#000080'>Month: %{x}</span><br>
        <span style='color:#0000cd'>Speed: %{y:.2f} m/s</span><br>
        <span style='color:#2a52be'>Sensor: ${selection.speed_column}</span>
        <extra></extra>
    `
});
            });
            const layout = {
                title: {
                    text: 'Monthly Average Wind Speed',
                    font: {
                        size: 20,
                        color: '#2c3e50'
                    }
                },
                xaxis: {
                    title: {
                        text: 'Month',
                        font: {
                            size: 18
                        }
                    },
                    type: 'category',
                    tickmode: 'array',
                    tickvals: monthNames,
                    ticktext: monthNames,
                    gridcolor: '#f0f0f0',
                    linecolor: '#f0f0f0'
                },
                yaxis: {
                    title: {
                        text: 'Average Wind Speed (m/s)',
                        font: {
                            size: 18
                        }
                    },
                    rangemode: 'tozero',
                    gridcolor: '#f0f0f0',
                    linecolor: '#f0f0f0'
                },
                legend: {
                    orientation: 'h',
                    y: -0.2,
                    font: {
                        size: 12
                    }
                },
                margin: {
                    l: 60,
                    r: 40,
                    b: 80,
                    t: 60,
                    pad: 10
                },
                hovermode: 'closest',
                hoverlabel: {
                    bgcolor: 'white',
                    font: {
                        size: 12
                    },
                    bordercolor: '#ddd'
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: {
                    family: 'Segoe UI, Roboto, sans-serif'
                }
            };
            Plotly.newPlot(graphContainer, traces, layout);
            // Show the modal
            document.getElementById('speed-graph-modal').style.display = 'block';
            setTimeout(() => {
                document.getElementById('speed-graph-modal').classList.add('show');
            }, 10);
        }
        // Display speed table
        function displaySpeedTable(data) {
            const tableContainer = document.getElementById('table-container');
            tableContainer.innerHTML = '';
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            // Create header row
            const headerRow = document.createElement('tr');
            const monthHeader = document.createElement('th');
            monthHeader.textContent = 'Month';
            headerRow.appendChild(monthHeader);
            data.selections.forEach(selection => {
                const th = document.createElement('th');
                th.textContent = `${selection.state} - ${selection.mast}`;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            // Create data rows
            data.monthly_data.forEach(monthData => {
                const row = document.createElement('tr');
                const monthCell = document.createElement('td');
                monthCell.textContent = monthData.month;
                row.appendChild(monthCell);
                monthData.values.forEach(value => {
                    const cell = document.createElement('td');
                    cell.textContent = value.toFixed(2) + ' m/s';
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });
            // Create overall average row
            const avgRow = document.createElement('tr');
            const avgLabel = document.createElement('td');
            avgLabel.textContent = 'Overall Average';
            avgLabel.style.fontWeight = '600';
            avgRow.appendChild(avgLabel);
            data.overall_averages.forEach(avg => {
                const cell = document.createElement('td');
                cell.textContent = avg.toFixed(2) + ' m/s';
                cell.style.fontWeight = '600';
                avgRow.appendChild(cell);
            });
            tbody.appendChild(avgRow);
            table.appendChild(tbody);
            tableContainer.appendChild(table);
            // Show the modal
            document.getElementById('speed-table-modal').style.display = 'block';
            setTimeout(() => {
                document.getElementById('speed-table-modal').classList.add('show');
            }, 10);
        }
        // Display wind rose diagram
        function displayWindRoseDiagram(data) {
            const windRoseContainer = document.getElementById('wind-rose-container');
            windRoseContainer.innerHTML = '';
            // Prepare data for wind rose chart
            const traces = [];
            data.frequency_data.forEach((sectorData, index) => {
                const selection = data.selections[index];
                const sectorFrequencies = sectorData.map(sector => sector.frequency);
                const sectorMidpoints = sectorData.map(sector => sector.midpoint);
                traces.push({
                    r: sectorFrequencies,
                    theta: sectorMidpoints,
                    name: `${selection.state} - ${selection.mast}`,
                    type: 'barpolar',
                    marker: {
                        color: getColor(index),
                        opacity: 0.7
                    },
                    hovertemplate: `
                        <b>${selection.state} - ${selection.mast}</b><br>
                        Direction: %{theta}°<br>
                        Frequency: %{r:.2f}%<br>
                        Sensor: ${selection.direction_column}
                        <extra></extra>
                    `
                });
            });
            const layout = {
                title: {
                    text: 'Wind Frequency Rose',
                    font: {
                        size: 16,
                        color: '#2c3e50'
                    }
                },
                font: {
                    family: 'Segoe UI, Roboto, sans-serif',
                    size: 12
                },
                polar: {
                    radialaxis: {
                        title: {
                            text: 'Frequency (%)',
                            font: {
                                size: 12
                            }
                        },
                        angle: 90,
                        tickangle: 90,
                        tickfont: {
                            size: 10
                        },
                        gridcolor: '#f0f0f0'
                    },
                    angularaxis: {
                        rotation: 90,
                        direction: 'clockwise',
                        tickmode: 'array',
                        tickvals: data.sector_midpoints,
                        ticktext: data.sector_labels,
                        gridcolor: '#f0f0f0'
                    },
                    bgcolor: 'rgba(0,0,0,0)'
                },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.1,
                    font: {
                        size: 12
                    }
                },
                hovermode: 'closest',
                hoverlabel: {
                    bgcolor: 'white',
                    font: {
                        size: 12
                    },
                    bordercolor: '#ddd'
                },
                paper_bgcolor: 'rgba(0,0,0,0)'
            };
            Plotly.newPlot(windRoseContainer, traces, layout);
            // Show the modal
            document.getElementById('direction-diagram-modal').style.display = 'block';
            setTimeout(() => {
                document.getElementById('direction-diagram-modal').classList.add('show');
            }, 10);
        }
        // Display wind rose table
        function displayWindRoseTable(data) {
            const tableContainer = document.getElementById('wind-rose-table-container');
            tableContainer.innerHTML = '';
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            // Create header row
            const headerRow = document.createElement('tr');
            const sectorHeader = document.createElement('th');
            sectorHeader.textContent = 'Sector Range';
            headerRow.appendChild(sectorHeader);
            data.selections.forEach(selection => {
                const th = document.createElement('th');
                th.textContent = `${selection.state} - ${selection.mast}`;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            // Create data rows
            data.frequency_data[0].forEach((_, sectorIndex) => {
                const row = document.createElement('tr');
                const sectorCell = document.createElement('td');
                sectorCell.textContent = data.sector_labels[sectorIndex];
                row.appendChild(sectorCell);
                data.frequency_data.forEach((siteData, siteIndex) => {
                    const cell = document.createElement('td');
                    const frequency = siteData[sectorIndex].frequency;
                    cell.textContent = frequency.toFixed(2) + '%';
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            tableContainer.appendChild(table);
            // Show the modal
            document.getElementById('direction-table-modal').style.display = 'block';
            setTimeout(() => {
                document.getElementById('direction-table-modal').classList.add('show');
            }, 10);
        }
        // Helper function to get distinct colors for each line
        function getColor(index) {
            const colors = [
                '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6',
                '#1abc9c', '#d35400', '#34495e', '#16a085', '#c0392b',
                '#2980b9', '#8e44ad', '#27ae60', '#f1c40f', '#e67e22',
                '#7f8c8d', '#2c3e50', '#d35400', '#3498db', '#e74c3c'
            ];
            return colors[index % colors.length];
        }
        // Initialize the application
        function init() {
            initModals();
            // Set default dates (today and one year ago)
            const today = new Date();
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(today.getFullYear() - 1);
            document.getElementById('start-date').valueAsDate = oneYearAgo;
            document.getElementById('end-date').valueAsDate = today;
        }
        // Start the application
        init();
    </script>
{% endblock %}